name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
    
    - name: Install Dependencies
      run: |
        # Install any dependencies if needed
        # Currently using only system frameworks
        echo "No additional dependencies to install"
    
    - name: Build for iOS Simulator
      run: |
        set -o pipefail
        xcodebuild -scheme LensDataBase \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
          -configuration Debug \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty
    
    - name: Run Unit Tests
      run: |
        set -o pipefail
        xcodebuild -scheme LensDataBase \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
          -configuration Debug \
          test \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty
    
    - name: Run SwiftLint
      run: |
        if which swiftlint > /dev/null; then
          swiftlint --config .swiftlint.yml
        else
          echo "SwiftLint not installed, skipping..."
        fi
    
    - name: Archive build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifacts
        path: |
          build/
          *.ipa
        retention-days: 30
    
    - name: Generate test report
      if: always()
      run: |
        # Generate test coverage report if tests were run
        echo "Test execution completed"